% !Mode:: "TeX:UTF-8"

\chapter{芯片热建模方法}\label{chap:model}

为了应对超大规模集成电路功耗和的增长，在设计阶段做热分析变得越来越重要，做热分析需要用到热模型。
超大规模集成电路早期设计阶段，就是在还没有版图信息时就需要做热分析，现在体系结构层面的热管理技术也利用简洁热模型做温度预测。
要做热建模的根本原因是，温度的波动不是简单正比于功耗，也不是功耗密度。
在空间和时间上还有很多其他因素显著影响温度分布，都是要考虑进去的。这些因素包括热扩散和时空温度滤波效应。
因此，为了执行精确的热分析，温度必须直接建模。

热量从一个小的界面传到大的界面是发生热扩散。在时域长热时间常数的硅片和封装中，温度过滤往往会滤掉功率和功率密度的快速变化（高频分量）。
功率和功率密度在一个很小的尺寸上变化也会发生空间温度过滤（高空间频率）。

这一章主要介绍一下热模型基本知识尤其是热系统与电路系统的对偶关系，然后详细介绍 HotSpot 简洁的热建模方法。
本论文中的方法实现就是采用的 HotSpot 热模型。

\section{热传导理论}\label{sec:thermal}
所有的集成电路产生的热必须被移除或传送到周围环境当中，不然的话，温度积累会越来越高。
根据热力学第一定律，能量守恒定律，从热区域传出的热能和冷却液传入的热能是相等的。
热力学第二定律是，热一定是由热的区域传到冷的区域。

热传导控制方程是傅里叶定律：
\begin{equation}\label{eq:fourier}
q = -k\frac{dT}{dx}
\end{equation}

式 \eqref{eq:fourier} 是傅里叶定律的一维形式。
其中，$ q $ 是热通量（$W/m^2$），即单位面积单位时间的热流。 $k $ 是材料的热导率（$W/(m \cdot K)$）。
式 \eqref{eq:fourier} 表明在介质的一点上，热通量 $q$ 是和这一点上的温度梯度成正比关系的。
减号表示热流是向温度降低的方向。
\pic{ 一维热传导}{width=0.4\columnwidth}{fig/heat}
参考图 \ref{fig/heat}，这里 $q = Q/A $ ，其中 $Q$ 是热传输率，就是单位时间上的热生成或者消散的热量，通常情况下等于功耗 $P$，也就是能量消耗率。 
$A$ 是热传导面积。 式 \eqref{eq:fourier} 就变成 式 \eqref{eq:fourier1}。
\begin{equation}\label{eq:fourier1}
Q = -kA\frac{T_2-T_1}{L}
\end{equation}

如果定义热阻 $R_{th} = (T_1 -T_2)/Q$ ，温度下降至除以热传输率，我们可以得到
\begin{equation}\label{eq:Rth}
R_{th} = (T_1-T_2)/Q = \frac{1}{k}\frac{L}{A}
\end{equation}

可以发现式 \eqref{eq:fourier} 和大家熟知的电路理论中的欧姆定律相似：
\begin{equation}\label{eq:Ohm}
R = (V_1-V_2)/I = \rho \frac{L}{A}
\end{equation}

因此电路和热系统有一个有趣的对偶 \raisebox{0.5mm}{------}热阻率（$1/k$）和电阻率（$\rho$）；
温度差（$\Delta T$）和电压差（$\Delta V$）；
热传导率（$Q$ 或者功耗 $P$ ）和电流（$I$）；
热阻（$R_{th}$） 和电阻（$R$）。

热传导也是一个瞬态过程，更加通用的带时间的热扩散方程为：
\begin{equation}\label{eq:general}
 \rho c_p \frac{\partial T(x,y,z,t)}{\partial t} = \nabla \cdot[k(x,y,z,T)\nabla T(x,y,z,t)] +g(x,y,z,t)
\end{equation}
其中，$\rho$ 是材料的密度（$kg/m^3$），不是电阻率；$g$ 是热源的体积功耗密度（$W/m^3$）；
$c_p$ 是比热（$J/(kg \cdot ^\circ C)$）。
%在这里热导率$k$ 实际上是一个位置函数，

对于稳态情况，就是式 \eqref{eq:general} 中 $\partial T/\partial t $ 项为 0。
可以验证，稳态下热扩散方程的一维形式可以简化成式 \eqref{eq:fourier} 的傅里叶定律。

假设 $g$ 和 $k$ 是常数，将式 \eqref{eq:general}写成一维形式，两遍从 $0$ 到 $L$积分变量 $x$，$g\cdot L = Q/A = q$，即热通量， 就得到了如下形式：
\begin{equation}\label{eq:general1}
 (\rho c_p A L) \frac{d T(t)}{d t} = k A \frac{\Delta T(t)}{L} + Q
\end{equation}

式 \eqref{eq:general1} 的右边第一项是通过热阻 $R_{th}$的热量，与式 \eqref{eq:Rth}相似。注意$\Delta T = T_2 - T_1$。
该式可以变换为
\begin{equation}\label{eq:cap}
 C_{th} \frac{d T(t)}{d t} + \frac{ T_1 -T_2}{R_{th}} = Q
\end{equation}
其中，$C_{th} = \rho c_p A L = \rho c_p V $ 被定义为热容， $V$ 是材料的体积。

根据电路理论，$ C  \frac{d V(t)}{d t} = i_c(t)$ ， 表示通过电容的电流量等于它的电容值与它两端电压差的一阶导的乘积。
这正类似于式 \eqref{eq:cap} 中的第一项。这也正是定义 $C_{th}$为热容的原因。
热容表示材料的热吸收能力，正如电容表示材料吸收积累电荷的能力。
式 \eqref{eq:cap} 表示通过热容的热流（AC部分） 加上通过热阻的热流（DC部分）等于通过该材料的总热流。

表 \ref{tab:duality} 中总结了热系统和电系统的对偶现象，HotSpot简洁热建模方法构建热容热阻网络将会用到这个对偶关系。

\begin{table}[H]
\centering
\caption{热系统与电系统的对偶关系}\label{tab:duality}{
 \begin{tabular}{|c|c||c|c|}
 \hline
 \hline
 热系统 &  单位 & 电系统 & 单位 \\
 \hline 
 \hline
 $P$，功耗         & $W$   & $I$，电流 & $A$  \\
 \hline
 $T$，温度         & $K$   & $V$，电压 & $V$ \\
 \hline
 $R_{th}$，热阻    & $K/W$ & $R$，电阻 & $\Omega$ \\
 \hline
 $C_{th}$，热容    & $J/K$ & $C$，电容 & $F$ \\
 \hline
 \hline
 \end{tabular}
 }
 \end{table}
\section{HotSpot热建模方法}\label{sec:hotspot}

%我们首先介绍对多层封装结构的简洁RC热建模方法，将硅芯片、散热层、热界面材料、散热片等部件都考虑进去。
%每一层可以用不同的级别的细节来建模，比如功能单元或者常规网格单元。
HotSpot 热建模方法提供了一种精确有效构建简洁热 RC 网络方法，可以简化热扩散方程。

大多现在VLSI系统的封装有若干不同材料的叠层组成，如图 \ref{fig/layers}。
\pic{ 典型CBGA封装的堆叠层}{width=0.7\columnwidth}{fig/layers}
HotSpot热模型就以此为例来说明。
典型的层有：散热片，散热层，热界面材料（导热膏），硅衬底，互连层，C4垫，陶瓷封装衬底，焊料球等。
堆叠芯片封装（SCP）和 3D IC设计也是堆叠分层结构，可以作为通用堆叠结构的扩展很容易建模，如图 \ref{fig/path}。
\pic{HotSpot中用的抽象堆叠层结构}{width=0.5\columnwidth}{fig/path}
硅器件层产生的热有两条主要传输路径如图 \ref{fig/path}，上面是主要热流路径，从硅片传到 热界面材料，散热层，散热片，最后对流传到周围空气中；
下面是次要热流路径，从硅片传到互连层，C4垫，陶瓷封装衬底，焊料球，到印刷电路板。
HotSpot简洁热模型包含这两条热流路径的所有层，并特别强调主路经和片上互连层。
这些部分的对详细温度分布是很重要的，准确的温度分布才是需要的。在模型中也考虑各层的横向热流来实现更准确的温度估计。



%一个简洁的热建模方法一下有几个特征：
%首先，该方法在期望的抽象水平能给出详细的温度分布。例如，在芯片水平上热建模，一个节点代表整个芯片的温度是不能接受的。还有静态和瞬态热行为都被建模。
%其次，简洁热建模方法在需要的精度上建模，隐藏低层次的细节。这样时模型不会比必要的更复杂。
%第三，模型结构尽可能简单，只引入很少的一点计算开销。
%第四，该方法是边界条件独立的，这样外部环境的变化不会影响热模型的内部结构。

\subsection{主要热流路径}\label{sec:primary}

首先介绍一下主热流路径模型。
构建 HotSpot 热模型时，不同层的位置是首先要被确定的。
然后每一层被划分为若干块。例如图 \ref{fig:layer}(c) 中，可以根据不同的设计需求，将硅衬底按照结构单元或者规则网格划分。
 \begin{pics}{层划分和等效热阻示意图}{fig:layer}
     \addsubpic{大面积层的划分（顶视图）}{width=0.32\columnwidth}{fig/model1}
\addsubpic{块中的水平和垂直热阻（侧视图）}{width=0.32\columnwidth}{fig/model2}
\addsubpic{一层可被划分成任意数量的块（顶视图）}{width=0.32\columnwidth}{fig/model3}
 \end{pics}
为简单起见，图 \ref{fig:layer}(c) 只显示了三块。
其他影响整个芯片温度分布的层可以做类似于硅衬底层的建模。

对于并不需要太详细温度信息的层，我们可以如图 \ref{fig:layer}(a) 所示简单划分该层。
图 \ref{fig:layer}(a) 层中心遮挡部分是被另一个相邻曾覆盖，如\ref{fig:layer}(c) 所示的那样。
中心部分可以类似相邻层有相同数量的节点，也可以把这些节点合并成更少数量的节点，这取决于计算精度和速度。
图 \ref{fig:layer}(a) 中层周边部分，被分成了四个梯形块，每一块分配一个节点。

每一层每一块或者网格单元都有一个垂直热阻连接到下一层，和几个横向的热阻连接到同一层的相邻块或网格单元。
图 \ref{fig:layer}(b) 就是一个层的侧视图，表示出了横向和垂直热阻。
垂直热阻表示为$R_{vertical} = t/(k \cdot A)$ ，其中 $t$ 是该层厚度， $k$ 是该层材料的热导率， $A$ 是这块横截面的面积。
每一层不在划分成多个薄层，即这个方法不是完全 3D 的。这是早期设计阶段的一个合理近似，因为每一层相对较薄（$1 mm$ 或者更薄），
垂直方向更进一步的分化会引入更多计算量但不会明显提高精度。

横向热阻的计算不像垂直热阻那样简单，
因为横向热扩散必须考虑。
块一侧的横向热阻可以被看做层内相邻部分到这个特定块的热阻。
横向热阻通常比垂直热阻大得多，因为横向传热界面通常比垂直界面小得多。
为了阐明扩散热阻如何计算，考虑图 \ref{fig/spreading}中的相邻两块，块 1 和块 2。
长度分别为 $L1$ 和 $L2$ ，芯片厚度为 $t$ 。现在我们计算横向热阻 $R_{21}$ ， 
就是从块 2 中心到块 1 块 2交界边的热阻。考虑热量通过 $L_1t$ 和 $L_2t$定义的表面区域从块1传到块2。
接收热量的硅本体区域是 $L_2t$，本体厚度是 $W_2/2$。
有这些量之后，就可以通过~\cite{song1995constriction} 中的公式来计算扩散热阻。
\pic{扩散热阻示意图}{width=0.6\columnwidth}{fig/spreading}

每个节点也都有一个连接到地的热容 $C_{th} = \alpha c_p \rho t A$ ，其中 $c_p$ 和 $\rho$ 分别是材料的比热和密度。
因子  $\alpha \approx 0.5$ 是集中分布占热 RC 时间常数的比例因子。

最后，扩散到空气的对流热阻建模为 $R_c = 1/(h\cdot A_c)$ ， 其中 $A_c$ 是对流表面积， $h$ 是热传输系数，这是边界条件依赖的。
对于不同对流条件下典型散热片的典型 $h$ 值可以在散热参数表中找到。

这样主热流路径的建模就完成了，图 \ref{fig/layers} 中封装的从硅片到散热片到周围空气的主热流路径模型如图 \ref{fig/primary} 。 
%主热流路径模型中的热容和热阻的推导方法可以设置为不同的建模精度。
\pic{芯片$3 \times 3$网格单元简洁热模型示例（图\ref{fig/layers}中主热流路径倒置结构）}{width=0.7\columnwidth}{fig/primary}
图 \ref{fig/primary} 的例子中，硅芯片被划分为 $3 \times 3$ 网格单元。为了提升精度，热界面材料层划分与硅芯片相同。
散热层中热界面材料层正下方的部分的划分与热界面材料层相同，周围部分被划分为四个梯形。
散热片层分成五块：一块是散热层正下方对应部分，其余四块为周边梯形。
每一个网格单元映射热电路中的一个节点，由横向和垂直热阻连接它们。每一个节点都有一个连接周围环境的热容。
每一个硅片网格单元消耗的功耗被建模成“电流源”，连接到相应的节点。

\subsection{次要热流路径}\label{sec:secondary}

上一节解释了 HotSpot 主要热流路径的建模。次要传热路径，即硅衬底，芯片互连层，C4垫，陶瓷封装衬底，焊料球，印制电路板。
次要热流路径通常散去不可忽略的热量（高达$30\%$）。
忽略次要热流路径会导致温度预测不准确。本节中次要热流路径模型分成两部分，一部分对应互连层，另一部分就是从C4垫到印制电路板。

互连层热模型有两个方面，第一个是金属线的自热功率，$P_self = I^2\cdot R$，这里 $I$ 是导线中的电路，
$R = \rho_m \cdot l/A_m$ 是 导线电阻， $\rho_m$ 是金属电导率（与温度相关）， $l$ 和 $A_m$ 是金属线长度和截面积。
这里通常是估计各金属层上导线的平均长度和平均电流。详细的方法见~\cite{huang2004compact}。
第二就是每条金属线和它周围的层间介质的等效热阻，通孔在不同金属层之间的热传递也起到很重要的作用，也对其进行建模。

\pic{计算互连线和周围介质等效热阻示意图}{width=0.6\columnwidth}{fig/wire}
为构建模型，以图~\ref{fig/wire} 中的两条相邻互连线（线1 和 线2）为例。
顶上是其相邻金属层的正交互连线。所有的先周围都是层间介质。
互连线和周围层间介质的等效热阻等效热阻 $R_0$ 是从 线1 到其上方 $d/2$的区域。
其中 $d$ 是两个金属层之间层间介质的厚度。
$d$ 的另一半属于 线1 上面的金属层，计算那层等效热阻的时候才会考虑。
假设同一金属层中的所有信号线都是相同的，线1 和线2 是在同一时间消耗相同的功耗，具有相同的温度。
图中外虚线区域为近似等温面，用于计算 $R_0$ ， 它不与相邻层等温面重叠。
热传导角度为 $\theta = 2 \cdot tan^{-1}(D/(d+H))$ ，如图所示。
每条互连线对应的等效热阻为
\begin{equation}\label{eq:R0}
R_0 = ln(\frac{d+2r}{2r})/(\theta \cdot k_{ins} \cdot l)
\end{equation}
其中， $r = \sqrt{WH/\pi}$ ， $k_{ins}$ 是层间介质的热导率， $l$ 是互连线长度。

线 1 和线 2 之间也有横向热阻 $R_{lat}$ ，但是因为线 1 和线 2 相同而且有相同的温度，这里没有热传输，所以 $R_{lat}$ 被去除。

层间热也通过通孔传导。用于信号互连的通孔数量的简单近似是假定每条互连线有两个通孔，
一个连接到上层金属层，另一个连接到下层金属层。
每个通孔的热阻近似计算为 $R_{via} = t_v/(k_vA_v)$ ， 这里 $k_v$ 是通孔填充材料热导率， $t_v$ 和 $A_v$ 是瞳孔厚度和截面积。

两金属层之间的所有互连线和通孔的热阻可以看成是并联。所以组合两金属层之间所有热阻就能得到两金属层间的总等效热阻。

对于每个金属层和层间介质的热容，可以根据其尺寸和材料特性用 \ref{sec:primary} 节中的类似公式计算。

最后从C4垫到印制电路板的热模型也是一系列的热阻热容对，分别代表垫凸点/片下填充，陶瓷基板，球阵列和PCB对流。
热容和热阻的计算用 \ref{sec:primary} 节中主热流路径上各层的类似方法。
垫凸点热阻一端连接到互连层模型，另一端连接到代表陶瓷衬底的热容热阻，等等。

\section{热建模在动态温度管理中的应用}\label{sec:hotspotinDTM}

传统的动态温度管理是在芯片级进行的。芯片级动态温度管理通过功耗控制技术减少热产生密度，来达到控制温度的目的。
芯片级动态温度管理技术显著降低散热成本，对典型应用可以允许最大性能，但是对于超出设计温度点的应用程序，性能会显著降低。
另一方面微体系结构动态温度管理技术能提供更好的性能温度折中，因为具有调用芯片上不同单元的运行信息做处理的独特能力，
从而实现对芯片热行为更精细的控制。
HotSpot简洁热模型在微体系结构级上的应用是成功的。
从HotSpot得到的各单元瞬态和静态温度估计可以被送到一个精确的处理器仿真器中，在那里动态温度管理技术被实现和模拟。
反过来，精确的处理器仿真器提供微处理器的运行信息到体系结构级功耗模型，比如wattch ~\cite{Brooks:ISCA'00} 。
功耗模型的输出功耗又作为 HotSpot 的输入做仿真，更新运行温度信息。
这样形成一个可以使处理器进行温度感知操作的控制回路。
该回路在图 \ref{fig/DTMinhotspot} 表示出来。\\
\pic{动态温度管理仿真环境}{width=0.7\columnwidth}{fig/DTMinhotspot}


\section{本章小结}\label{sec:xiaojie3}

本章针对热建模方法进行了详细讨论分析。首先说明了热系统与电路系统的对偶性，可以用类似电路分析的方法表示热系统。
对 HotSpot 简洁热建模方法进行了说明，对处理器的主要热流路径和次要热流路径都进行了建模分析。
最后是介绍热模型在动态温度管理中的应用。热建模本来是在芯片设计阶段进行热分析的，但是很早就被引入动态温度管理方法中，
只要已知处理器上的功耗分布就能够利用热模型准确计算芯片的温度分布。这对众核动态温度管理相当重要。
本论文的方法就是用的 HotSpot 热模型做温度计算。
 HotSpot 热模型 在本文方法中的作用就是在 \ref{sec:hotspotinDTM} 节所描述那样。




















